<!DOCTYPE html>
<html>
<head>
    <title>Legal Events Extraction</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin: 20px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input[type="file"] { width: 100%; padding: 8px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .provider-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0; }
        .provider-card { border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
        .provider-card.selected { border-color: #007bff; background: #f8f9fa; }
        .classification-section { border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; background: #f9f9f9; }
        .classification-section label { font-weight: 500; cursor: pointer; }
        .help-text { font-size: 0.9em; color: #666; margin-top: 5px; }

        /* Processing indicator animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Legal Events Extraction</h1>
        <p>Upload legal documents for automated event extraction using AI.</p>
        <p style="font-size: 0.9em; color: #666;"><strong>Note:</strong> LangExtract is a standalone AI model that doesn't require additional model selection.</p>

        <!-- App Status Indicator -->
        <div class="app-status" style="margin: 20px 0; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724;">
            <strong>‚úÖ System Ready</strong> - All AI providers configured and models loaded. Ready to process documents.
        </div>

        <form action="/upload" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="files">Select Files:</label>
                <input type="file" id="files" name="files" multiple required
                       accept=".pdf,.docx,.txt,.msg,.eml,.jpg,.jpeg,.png">
                <small>Supported: PDF, DOCX, TXT, MSG, EML, JPG, JPEG, PNG</small>
            </div>

            <div class="form-group">
                <label>Document Extractor:</label>
                <div class="provider-grid">
                    {% for extractor in extractors %}
                    <div class="provider-card{% if extractor.id == selected_extractor %} selected{% endif %}">
                        <input type="radio" id="extractor_{{ extractor.id }}" name="extractor"
                               value="{{ extractor.id }}"{% if extractor.id == selected_extractor %} checked{% endif %}>
                        <label for="extractor_{{ extractor.id }}">{{ extractor.name }}</label>
                        <br><small>{{ extractor.description }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group">
                <label>Event Extraction Provider:</label>
                <div class="provider-grid">
                    {% for provider in providers %}
                    <div class="provider-card{% if provider.id == selected_provider %} selected{% endif %}">
                        <input type="radio" id="provider_{{ provider.id }}" name="provider"
                               value="{{ provider.id }}"{% if provider.id == selected_provider %} checked{% endif %}>
                        <label for="provider_{{ provider.id }}">{{ provider.name }}</label>
                        <br><small>{{ provider.description }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group" id="model-group" style="display: none;">
            <label for="model">Model:</label>
            <select id="model" name="model" required>
            <option value="">Select a model...</option>
            </select>
            <div id="model-details" class="model-details" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
            <div id="model-info"></div>
            </div>
            </div>

            <!-- Document Classification (Optional) -->
            <div class="form-group classification-section">
                <label>
                    <input type="checkbox" id="enable-classification" name="enable_classification">
                    üè∑Ô∏è Enable Document Classification
                </label>
                <div class="help-text">
                    Classify documents and add Document Type as 6th column. Enables downstream filtering in Excel/database tools.
                </div>
                <div id="classification-config" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <!-- Classification configuration will be loaded here -->
                    <div id="classification-loading">Loading classification options...</div>
                </div>
            </div>

            <button type="submit" id="process-btn">Process Documents</button>
        </form>

        <!-- Processing Status Indicator -->
        <div id="processing-status" class="processing-status" style="display: none; margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 5px; border-left: 4px solid #007bff;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="spinner" style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <div>
                    <strong id="status-title">Processing Documents...</strong><br>
                    <span id="status-message">Please wait while we extract legal events from your documents.</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dynamic model loading based on provider selection
        const providerInputs = document.querySelectorAll('input[name="provider"]');
        const modelGroup = document.getElementById('model-group');
        const modelSelect = document.getElementById('model');
        const modelDetails = document.getElementById('model-details');
        const modelInfo = document.getElementById('model-info');

        // Function to load models for a provider
        async function loadModelsForProvider(providerId) {
            try {
                const response = await fetch(`/api/models/${providerId}`);
                const data = await response.json();

                // Clear existing options except the placeholder
                modelSelect.innerHTML = '<option value="">Select a model...</option>';

                // Add model options
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.model_id;
                    option.textContent = `${model.display_name} ‚Ä¢ ${model.inline_display}`;
                    option.dataset.modelData = JSON.stringify(model);
                    modelSelect.appendChild(option);
                });

                console.log(`Loaded ${data.count} models for ${providerId}`);
            } catch (error) {
                console.error('Error loading models:', error);
                modelSelect.innerHTML = '<option value="">Error loading models</option>';
            }
        }

        // Function to show model details
        function showModelDetails(modelData) {
            if (!modelData) {
                modelDetails.style.display = 'none';
                return;
            }

            modelInfo.innerHTML = `
                <strong>${modelData.display_name}</strong><br>
                <span style="color: #666;">${modelData.category}</span><br>
                <div style="margin-top: 5px;">
                    <span style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">${modelData.cost_per_1m}</span>
                    <span style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">${modelData.context_window}</span>
                    ${modelData.quality_score ? `<span style="background: #d4edda; padding: 2px 6px; border-radius: 3px;">${modelData.quality_score}</span>` : ''}
                </div>
                ${modelData.badges && modelData.badges.length > 0 ?
                    `<div style="margin-top: 5px;">${modelData.badges.map(badge =>
                        `<span style="background: #cce5ff; padding: 1px 4px; border-radius: 2px; font-size: 0.8em; margin-right: 3px;">${badge}</span>`
                    ).join('')}</div>` : ''}
            `;
            modelDetails.style.display = 'block';
        }

        // Handle provider selection change
        providerInputs.forEach(input => {
            input.addEventListener('change', function() {
                if (this.checked) {
                    const providerId = this.value;

                    // LangExtract doesn't need model selection
                    if (providerId === 'langextract') {
                        modelGroup.style.display = 'none';
                        modelSelect.required = false;
                        modelSelect.value = '';
                        modelDetails.style.display = 'none';
                    } else {
                        modelGroup.style.display = 'block';
                        modelSelect.required = true;
                        loadModelsForProvider(providerId);
                        modelDetails.style.display = 'none';
                    }
                }
            });
        });

        // Handle model selection change
        modelSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value && selectedOption.dataset.modelData) {
                const modelData = JSON.parse(selectedOption.dataset.modelData);
                showModelDetails(modelData);
            } else {
                showModelDetails(null);
            }
        });

        // Load models for initially selected provider
        const initiallySelectedProvider = document.querySelector('input[name="provider"]:checked');
        if (initiallySelectedProvider) {
            const providerId = initiallySelectedProvider.value;

            // LangExtract doesn't need model selection
            if (providerId === 'langextract') {
                modelGroup.style.display = 'none';
                modelSelect.required = false;
            } else {
                modelGroup.style.display = 'block';
                modelSelect.required = true;
                loadModelsForProvider(providerId);
            }
        }

        // Handle classification checkbox
        const classificationCheckbox = document.getElementById('enable-classification');
        const classificationConfig = document.getElementById('classification-config');

        classificationCheckbox.addEventListener('change', function() {
            if (this.checked) {
                classificationConfig.style.display = 'block';
                loadClassificationConfig();
            } else {
                classificationConfig.style.display = 'none';
            }
        });

        // Load classification configuration
        async function loadClassificationConfig() {
            const loadingDiv = document.getElementById('classification-loading');
            loadingDiv.textContent = 'Loading classification options...';

            try {
                // For now, we'll use a simple configuration
                // In a full implementation, this would load from the backend
                setTimeout(() => {
                    loadingDiv.innerHTML = `
                        <div style="color: #28a745;">
                            ‚úÖ Classification enabled - will add Document Type column to results
                        </div>
                        <div style="font-size: 0.9em; color: #666; margin-top: 10px;">
                            Documents will be classified into categories like: Contract, Agreement, Invoice, Legal Document, etc.
                        </div>
                    `;
                }, 500);
            } catch (error) {
                loadingDiv.innerHTML = '<div style="color: #dc3545;">‚ùå Failed to load classification options</div>';
                console.error('Classification config error:', error);
            }
        }

        // Form submission handling - show processing indicator
        const form = document.querySelector('form');
        const processBtn = document.getElementById('process-btn');
        const processingStatus = document.getElementById('processing-status');
        const statusTitle = document.getElementById('status-title');
        const statusMessage = document.getElementById('status-message');

        form.addEventListener('submit', function(e) {
            // Show processing indicator
            processingStatus.style.display = 'block';

            // Update status message
            const selectedProvider = document.querySelector('input[name="provider"]:checked');
            const providerName = selectedProvider ? selectedProvider.nextElementSibling.textContent.trim() : 'AI Provider';
            let modelName = '';

            if (selectedProvider && selectedProvider.value !== 'langextract') {
                const selectedModel = document.getElementById('model').selectedOptions[0];
                modelName = selectedModel && selectedModel.textContent ? selectedModel.textContent.split(' ‚Ä¢ ')[0] : '';
            }

            statusTitle.textContent = 'Processing Documents...';
            statusMessage.textContent = `Extracting legal events using ${providerName}${modelName ? ' (' + modelName + ')' : ''}. This may take a few moments.`;

            // Disable the submit button to prevent double-submission
            processBtn.disabled = true;
            processBtn.textContent = 'Processing...';

            // Scroll to the processing indicator
            processingStatus.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });

        // Hide processing indicator when page loads (in case of browser back button)
        window.addEventListener('load', function() {
            processingStatus.style.display = 'none';
            processBtn.disabled = false;
            processBtn.textContent = 'Process Documents';
        });
    </script>
</body>
</html>
