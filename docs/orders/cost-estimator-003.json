{
  "order_id": "cost-estimator-003",
  "priority": "high",
  "version": "v1.0",
  "supercontext": {
    "repository": "docling_langextract_testing",
    "mission": "Deliver accurate, pre-extraction cost previews that reflect both document and event processing layers across all user surfaces."
  },
  "goal": "Close the remaining parity gaps by upgrading the CLI and Streamlit comparison views to use the two-layer estimator, and ensure cost previews do not trigger paid document extractors during estimation.",
  "execution_instructions": [
    "Treat the two-layer estimator (`estimate_cost_two_layer`) as the single source of truth whenever both `doc_extractor` and event model context are available.",
    "Reuse the lightweight page-count heuristics from `document_page_estimator` for any pre-processing cost calculations—never call the paid extractor just to size a document.",
    "Keep CLI and UI messaging aligned so that document extraction, event extraction, and total cost are always shown (or clearly flagged as unavailable)."
  ],
  "tasks": [
    {
      "id": "stop-paid-prefetch",
      "description": "Prevent cost previews from invoking paid document extractors.",
      "steps": [
        "Review `extract_all_documents_for_estimation` and the surrounding Streamlit flow; short-circuit the Qwen/Gemini extraction path when the goal is estimation only.",
        "Add a fast path that uses `estimate_document_pages` and, when possible, previously cached text (Docling) instead of firing a paid request.",
        "Surface a warning or confidence note if the page estimate falls back to low-confidence heuristics so users know the preview is approximate."
      ]
    },
    {
      "id": "streamlit-layered-table",
      "description": "Upgrade the Streamlit comparison table to include Layer 1 costs.",
      "steps": [
        "Replace the current `estimate_all_models` call inside the comparison table with a two-layer variant that reuses the page estimate from the panel header.",
        "Display document extraction, event extraction, and total columns (currency formatted), and keep provider/model metadata intact.",
        "Ensure zero-cost paths (Docling) still render cleanly while paid extractors show non-zero document costs."
      ]
    },
    {
      "id": "cli-layered-output",
      "description": "Extend the CLI estimator output to show both layers.",
      "steps": [
        "Determine the active `doc_extractor` in `scripts/classify_documents.py` (derive from config/env) and plumb it into a new two-layer print helper.",
        "Update `print_cost_estimates` (and any callers) so the console block enumerates document extraction cost, event extraction cost, total, estimated pages, and token counts.",
        "Preserve the legacy single-layer path as a fallback when the doc extractor cannot be resolved, but log a warning so users know the preview is partial."
      ]
    },
    {
      "id": "tests-and-docs",
      "description": "Maintain coverage and documentation alignment.",
      "steps": [
        "Add or update tests in `tests/test_cost_estimator.py` (and any CLI-specific tests if applicable) to cover the new CLI formatting and the layered comparison rows.",
        "Document the revised behavior in `docs/reference/cost_estimator.md`, including the fact that estimation no longer hits paid extractors.",
        "If practical, add a quick regression that mocks a paid doc extractor choice and asserts the estimator uses the heuristic path instead of invoking `.extract`."
      ]
    }
  ],
  "acceptance_criteria": [
    "Streamlit cost tables and CLI output both display document extraction, event extraction, and combined totals whenever pricing data is available.",
    "Cost previews do not make outbound calls to paid document extractors; the estimation path relies on metadata/heuristics instead.",
    "Low-confidence page estimates are clearly labeled so users understand the potential variance.",
    "Unit tests cover the layered output in both CLI and UI helpers, and documentation reflects the new behavior."
  ],
  "constraints": {
    "what_not_to_do": [
      "Do not remove the existing two-layer helper APIs; build on them.",
      "Do not fire the Qwen or Gemini extractor during estimation—doing so reintroduces the pre-extraction billing bug.",
      "Avoid duplicating pricing constants; continue to source rates from the document extractor catalog."
    ],
    "escalation_guidance": "If the active document extractor cannot be determined in the CLI path, document the limitation in the release notes rather than guessing."
  },
  "testing": {
    "required_commands": [
      "uv run python -m pytest tests/test_cost_estimator.py -v",
      "uv run python scripts/classify_documents.py --estimate-only --max-chars 1600"
    ],
    "notes": "Manual Streamlit validation is recommended: run `uv run streamlit run app.py`, select a paid document extractor, and confirm the expanded panel and comparison table show layered costs without triggering paid extraction."
  }
}
