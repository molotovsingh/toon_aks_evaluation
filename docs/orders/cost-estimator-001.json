{
  "order_id": "cost-estimator-001",
  "priority": "medium",
  "version": "v1.0",
  "supercontext": {
    "repository": "docling_langextract_testing",
    "mission": "Give users a ballpark cost before running classification/extraction so they can choose providers with eyes open."
  },
  "goal": "Implement a lightweight cost estimator that runs after Docling extraction, uses token heuristics to estimate spend per provider, and surfaces the numbers in both CLI and Streamlit flows.",
  "execution_instructions": [
    "Limit scope to estimation only—no billing integration or provider API calls.",
    "Keep the estimator modular so future token stats (captured in metadata) can refine the predictions.",
    "Aim for clarity over precision; rough order-of-magnitude guidance is acceptable."
  ],
  "tasks": [
    {
      "id": "design-estimator",
      "description": "Define the cost heuristic.",
      "steps": [
        "Inspect existing metadata (`tokens_input`, `tokens_output`) to understand typical token usage.",
        "Draft a per-model table (input price/output price per 1M tokens) for the models exposed in the UI.",
        "Decide on a token estimate strategy (e.g., characters/4, or tokenizer call if available) and document assumptions."
      ]
    },
    {
      "id": "implement-helper",
      "description": "Add a reusable estimator module.",
      "steps": [
        "Create `src/ui/cost_estimator.py` (or similar) with a function that accepts extracted text and returns `{model_id: {'tokens': est, 'cost': est_cost}}`.",
        "Include defaults for input/output token split (e.g., 90% input, 10% output) and allow overrides per model.",
        "Write unit tests covering the estimator logic and price table (e.g., `tests/test_cost_estimator.py`)."
      ]
    },
    {
      "id": "surface-estimates",
      "description": "Show the estimates in CLI/Streamlit flows.",
      "steps": [
        "In Streamlit (`process_documents_with_spinner` or nearby), display the estimated tokens/costs after Docling succeeds and before provider selection.",
        "Update `scripts/classify_documents.py` (dry run and execute paths) to print the same estimates when text extraction is complete.",
        "Make sure the UI labels include caveats (e.g., \"Estimates only — actual billing may vary\")."
      ]
    },
    {
      "id": "calibration-note",
      "description": "Document how to refine the estimator with real data.",
      "steps": [
        "Add a short section to `docs/reference/cost_estimator.md` describing how predicted vs actual tokens can be compared using `_metadata.json`.",
        "Recommend logging the delta (estimate vs actual) for future tuning.",
        "Mention future enhancements (e.g., converting the heuristic to a regression once enough data exists)."
      ]
    }
  ],
  "acceptance_criteria": [
    "A helper module returns per-model token/cost estimates for a given extracted document.",
    "Estimates appear in both Streamlit (post-Docling stage) and CLI runs (dry/execute) with clear labeling.",
    "Unit tests cover the estimator logic and pricing table.",
    "Documentation explains the heuristic and how to refine it later."
  ],
  "constraints": {
    "what_not_to_do": [
      "Do not hit provider APIs or rely on live billing data.",
      "Do not change the extraction pipeline; plug the estimator in after text is available.",
      "Avoid hard-coding sensitive pricing info—store it in one place (e.g., the helper module)."
    ],
    "escalation_guidance": "If token estimation proves wildly inaccurate during testing, document the discrepancy and pause implementation for calibration rather than committing misleading values."
  },
  "testing": {
    "required_commands": [
      "uv run python -m unittest tests/test_cost_estimator.py",
      "uv run python scripts/classify_documents.py --files test_documents/abc_xyz_contract_dispute.txt --max-chars 1600"
    ],
    "notes": "Manual Streamlit verification recommended: run `uv run streamlit run app.py`, upload a sample doc, and confirm estimates render as expected."
  }
}
