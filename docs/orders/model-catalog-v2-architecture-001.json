{
  "order_id": "model-catalog-v2-architecture-001",
  "priority": "high",
  "version": "v2.0",
  "supercontext": {
    "repository": "docling_langextract_testing",
    "mission": "Design the next version of the multi-provider model catalog, including a consistent metadata pipeline so runtime model overrides (e.g., Qwen, GPT-OSS) are tracked accurately."
  },
  "goal": "Produce a concrete design for a centralized model registry (and metadata propagation), covering runtime overrides, capability flags, and logging requirements before implementation work begins.",
  "execution_instructions": [
    "Review CLAUDE.md, AGENTS.md, and existing orders (openrouter-gpt5-ux-001, pre-commit-python-guardrail-001) to align with current guardrails.",
    "Focus on architecture and documentation only—do not modify code in this order.",
    "If you find conflicting version or configuration data, note it explicitly rather than picking a side."
  ],
  "tasks": [
    {
      "id": "current-state-audit",
      "description": "Document today’s data flow for model selection and metadata.",
      "steps": [
        "Enumerate where model lists and defaults live (app.py, openrouter_adapter.py, pipeline_metadata.py, .env, docs).",
        "Trace how runtime_model is passed from Streamlit to `LegalEventsPipeline` and how metadata fallbacks (e.g., OPENROUTER_MODEL) override runtime choices.",
        "Identify duplicated capability flags (JSON mode support, Responses API, pricing tables)."
      ]
    },
    {
      "id": "catalog-schema-design",
      "description": "Define the structure for model catalog v2.",
      "steps": [
        "Choose the storage format (Python module vs YAML/JSON) and outline the schema: provider, model_id, display_name, category, cost, context window, badges, `supports_json_mode`, `requires_responses_api`, `status` (stable/experimental), documentation links.",
        "Specify helper APIs (`list_models(provider)`, `get_model(model_id)`, `get_capabilities(model_id)`, `resolve_runtime_model(provider, selection, env_defaults)`).",
        "Explain how environment variables map into the registry (e.g., OPENROUTER_MODEL must correspond to a catalog entry)."
      ]
    },
    {
      "id": "metadata-propagation-plan",
      "description": "Fix the gaps seen in recent runs (model name logged as GPT-4o-mini; timing fields swapped).",
      "steps": [
        "Describe the changes needed in `LegalEventsPipeline` and `PipelineMetadata.from_pipeline` so `provider_model` uses the extractor’s actual active model (runtime override).",
        "Plan how timing metrics should be captured (Docling seconds, Extractor seconds, Total seconds) without mixing per-record and per-pipeline values.",
        "Propose tests or logging hooks to detect mismatch (e.g., assert metadata model matches `pipeline.event_extractor.config.active_model`)."
      ]
    },
    {
      "id": "risk-assesment-and-rollout",
      "description": "Surface risks and outline implementation checkpoints.",
      "steps": [
        "Call out potential hazards: stale Streamlit caches, incompatible env vars, registry drift, unsupported models (Qwen statuses).",
        "Outline incremental rollout: create registry module, refactor UI, refactor adapters, update metadata, add tests, and docs.",
        "List validation steps (unit tests, smoke run with Qwen/GPT-OSS) that will be required once the implementation order executes."
      ]
    }
  ],
  "acceptance_criteria": [
    "Design document (e.g., `docs/reports/model-catalog-v2-plan.md`) consolidates the schema, helper API design, metadata propagation strategy, and rollout steps.",
    "Current pain points (runtime model not recorded, timing fields misreported) are explicitly addressed in the plan.",
    "Risks and validation steps are enumerated so the subsequent implementation order has a clear checklist.",
    "Speculative models (Qwen, GPT-OSS) are annotated with their status (tested vs placeholder)."
  ],
  "constraints": {
    "what_not_to_do": [
      "Do not edit application code or adapters in this order.",
      "Do not remove existing models from the catalog; mark uncertain ones as experimental.",
      "Avoid committing to a storage format that conflicts with existing configuration without justification."
    ],
    "escalation_guidance": "If the audit reveals conflicting defaults (e.g., README vs .env), document the discrepancy in the plan and flag it for follow-up."
  },
  "testing": {
    "required_commands": [],
    "notes": "Planning only—tests will be specified in the follow-up implementation order."
  }
}
