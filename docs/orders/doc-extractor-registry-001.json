{
  "order_id": "doc-extractor-registry-001",
  "version": "2.0",

  "classification": {
    "type": "feature",
    "risk_level": "medium",
    "estimated_complexity": "moderate",
    "requires_human_review": true,
    "affects_production": true
  },

  "context": {
    "problem_statement": "Adding/removing document extractors currently requires touching multiple files (factory, UI, cost estimator, prompts). We want a single registry that makes extractors as plug-and-play as Lego bricks while still supporting model-specific prompts and config.",
    "goal": "Introduce a centralized document extractor registry with per-model metadata (pricing, prompts, availability flags) and refactor the pipeline, UI, and CLI to consume it.",
    "non_goals": [
      "Reintroduce Gemini vision (handled by removal order)",
      "Change event extractor logic or prompts"
    ],
    "related_orders": [
      "remove-gemini-vision-001"
    ]
  },

  "execution": {
    "prerequisites": {
      "tools": ["uv"],
      "environment": [],
      "pre_checks": [
        "Tests on main are green"
      ]
    },
    "tasks": [
      {
        "id": "T1",
        "description": "Design the registry schema for document extractors (metadata + prompt overrides).",
        "type": "automated",
        "estimated_duration": "20m",
        "validation": "New schema documented (fields for display info, pricing, enabled flag, prompt config).",
        "rollback": "Discard schema file/change.",
        "depends_on": []
      },
      {
        "id": "T2",
        "description": "Implement the registry and migrate existing extractors (Docling, Qwen-VL).",
        "type": "automated",
        "estimated_duration": "30m",
        "validation": "Registry lives in `src/core/document_extractor_catalog.py` (or new module) and exposes accessors returning metadata and prompt config.",
        "rollback": "Revert module changes.",
        "depends_on": ["T1"]
      },
      {
        "id": "T3",
        "description": "Refactor factory, pipeline, UI, and CLI to rely on the registry.",
        "type": "automated",
        "estimated_duration": "40m",
        "validation": "Extractor factory pulls from registry, Streamlit options auto-generate from enabled entries, CLI help lists enabled extractors, cost estimator uses registry pricing. No hardcoded extractor lists remain.",
        "rollback": "Revert integration changes.",
        "depends_on": ["T2"]
      },
      {
        "id": "T4",
        "description": "Support model-specific prompt/config overrides.",
        "type": "automated",
        "estimated_duration": "30m",
        "validation": "Registry entry can specify prompt_id or inline prompt; pipeline passes it into adapters; add sample override for Qwen-VL.",
        "rollback": "Revert prompt integration.",
        "depends_on": ["T3"]
      },
      {
        "id": "T5",
        "description": "Update documentation and tests to reflect registry-driven extractors.",
        "type": "automated",
        "estimated_duration": "20m",
        "validation": "Docs (README/AGENTS/cost estimator reference) explain registry usage; unit tests cover registry access + prompt override logic.",
        "rollback": "Revert doc/test changes.",
        "depends_on": ["T3", "T4"]
      }
    ],
    "checkpoints": [
      {
        "after_task": "T3",
        "verify": [
          "`uv run streamlit run app.py` shows only registry-enabled extractors",
          "CLI `--help` mentions the same set"
        ],
        "pause_for_review": false
      }
    ]
  },

  "constraints": {
    "must": [
      "Registry entries include an `enabled` flag and optional prompt config",
      "Existing Docling + Qwen-VL behavior remains intact",
      "Backwards-compatible environment variable behavior (DOC_EXTRACTOR=docling still works)"
    ],
    "do_not": [
      "Do not re-add Gemini vision",
      "Do not duplicate pricing/config data outside the registry"
    ],
    "performance": {
      "max_execution_time": "45m",
      "max_memory_usage": "2GB",
      "max_api_calls": 0
    }
  },

  "validation": {
    "acceptance_criteria": [
      "Single registry controls available document extractors and their prompts/pricing",
      "UI/CLI/cost estimator automatically reflect registry contents",
      "Tests cover registry access and prompt override injection"
    ],
    "testing": [
      "uv run python -m pytest tests/test_cost_estimator.py -v"
    ],
    "post_checks": [
      "Run Streamlit and switch between Docling/Qwen-VL to confirm prompts load as expected",
      "Inspect registry JSON/dict to ensure toggling `enabled` hides extractors everywhere"
    ]
  },

  "metadata": {
    "created_at": "2025-02-15T12:15:00Z",
    "updated_at": "2025-02-15T12:15:00Z",
    "created_by": "agent@company.com",
    "status": "draft"
  },

  "audit": {
    "require_approval": true,
    "approvers": ["tech-lead@company.com"],
    "escalation_triggers": [
      "Registry design conflicts with pending removal order",
      "Prompt override mechanism breaks existing Qwen-VL output"
    ],
    "fallback": "Revert to previous two-extractor implementation if registry refactor causes instability"
  }
}
