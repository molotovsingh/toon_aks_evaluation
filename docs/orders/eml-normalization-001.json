{
  "order_id": "eml-normalization-001",
  "priority": "high",
  "version": "v1.0",
  "supercontext": {
    "repository": "docling_langextract_testing",
    "mission": "Ensure all supported document types—including uploaded emails—produce clean, structured text for the legal events pipeline without manual cleanup."
  },
  "goal": "Normalize .eml ingestion in the Streamlit + Docling pipeline so uploaded emails yield high-quality plain text, Markdown, and metadata comparable to PDF extractions.",
  "execution_instructions": [
    "Review CLAUDE.md design mantras before planning code changes (start small, ship value, prefer simple patterns).",
    "Work from a fresh uv environment (`uv sync`) if dependencies change; document any new libraries and run SECURITY.md checks before adding them.",
    "Follow tasks in order. If a step is blocked or out of scope, stop and escalate instead of guessing.",
    "Capture interim findings and final verification notes in `docs/reports/eml-normalization-001-completion.md`."
  ],
  "tasks": [
    {
      "id": "eml-audit",
      "description": "Assess current .eml handling to understand failure modes and noise sources.",
      "steps": [
        "Inspect `src/core/document_processor.py` and `src/core/docling_adapter.py` to confirm how .eml files are read and how metadata is propagated.",
        "Collect at least three representative `.eml` fixtures (plain text, HTML-only, multipart with attachment) under `tests/test_documents/emails/`.",
        "Run the Streamlit upload flow (`uv run python -m streamlit run app.py`) with a sample `.eml` and capture the extracted plain text for baseline comparison."
      ]
    },
    {
      "id": "eml-parser-implementation",
      "description": "Implement a robust email parser that extracts readable bodies and key headers.",
      "steps": [
        "Use Python's `email` package to parse the raw message, selecting `text/plain` parts when available and gracefully decoding quoted-printable or base64 content.",
        "When only HTML content exists, strip tags to produce plain text while retaining essential formatting cues (lists, links) where feasible.",
        "Surface normalized header fields (Subject, From, To, Cc, Date, Message-ID) and ignore attachments unless explicitly required; truncate or hash large attachment payload markers instead of inlining base64."
      ]
    },
    {
      "id": "pipeline-integration",
      "description": "Integrate the new parser into the document extraction pipeline and expose metadata.",
      "steps": [
        "Update `DocumentProcessor.extract_text` to route `.eml` files through the new parser and return clean Markdown + plain text outputs.",
        "Ensure `ExtractedDocument.metadata` includes parsed header fields and the chosen extraction method (e.g., `email_parser`).",
        "Add safeguards so unsupported encodings or malformed messages fail gracefully with actionable log warnings without crashing the pipeline."
      ]
    },
    {
      "id": "testing-and-validation",
      "description": "Cover the new behavior with automated tests and verification docs.",
      "steps": [
        "Create unit tests (e.g., `tests/test_document_processor_eml.py`) that load the new fixtures, assert header extraction, plain text cleanliness (no MIME boundaries), and HTML stripping.",
        "If fixtures rely on baseline metadata, mock external dependencies as needed to keep tests hermetic.",
        "Document manual validation steps in `docs/reports/eml-normalization-001-completion.md`, including Streamlit screenshots or textual evidence from the upload flow."
      ]
    },
    {
      "id": "documentation-updates",
      "description": "Communicate the new .eml capabilities and requirements.",
      "steps": [
        "Update `README.md` (Streamlit usage section) to note .eml support, any limitations, and mention new fixtures.",
        "Add troubleshooting guidance to `SECURITY.md` or `docs/` if new dependencies or environment variables are introduced; if none, explicitly state that no security/config changes were needed.",
        "Log completed work, tests run, and outstanding risks in `docs/reports/eml-normalization-001-completion.md`."
      ]
    }
  ],
  "acceptance_criteria": [
    ".eml uploads produce plain text without MIME boundaries, attachment base64 blobs, or raw HTML tags when extracted through the Streamlit pipeline.",
    "Essential email headers (Subject, From, Date) are available in `ExtractedDocument.metadata` and surfaced in downstream event extraction prompts.",
    "Unit tests covering plain, HTML, and multipart .eml fixtures pass locally (`uv run python -m pytest tests/test_document_processor_eml.py -v`).",
    "Documentation and completion report updates are present, with manual validation evidence recorded."
  ],
  "constraints": {
    "what_not_to_do": [
      "Do not regress existing PDF/DOCX/TXT extraction paths or bypass Docling configuration toggles in `DoclingConfig`.",
      "Avoid introducing heavy parsing dependencies without prior security review; prefer Python standard library solutions.",
      "Do not commit sensitive sample emails—sanitize fixtures (redact names/addresses) before adding them.",
      "Do not swallow parsing errors silently; emit structured warnings to aid troubleshooting."
    ],
    "escalation_guidance": "If email parsing reveals complex encodings or vendor-specific formats that exceed the planned scope, document the blocker in the completion report and escalate via the project maintainer before expanding dependencies or scope."
  }
}
