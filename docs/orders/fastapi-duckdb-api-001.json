{
  "order_id": "fastapi-duckdb-api-001",
  "version": "1.0",

  "classification": {
    "type": "feature",
    "risk_level": "medium",
    "estimated_complexity": "moderate",
    "requires_human_review": true,
    "affects_production": false
  },

  "context": {
    "problem_statement": "Expose the DuckDB pipeline_runs dataset over a small FastAPI service to enable dashboarding and programmatic analytics without introducing a database server.",
    "background": "duckdb-ingestion-001 shipped ingestion + queries; duckdb-ingestion-002 will finalize docs/evidence. We now need a read-only HTTP API surface on top of runs.duckdb.",
    "stakeholders": ["analytics@company", "app-team@company", "infra@company"],
    "related_orders": ["duckdb-ingestion-001", "duckdb-ingestion-002"],
    "documentation_links": [
      "docs/reports/duckdb-ingestion-plan.md",
      "docs/reports/duckdb-queries.sql"
    ]
  },

  "objective": {
    "goal": "Ship a read-only FastAPI service that lists runs, returns run details, and provides basic model/provider aggregations backed by DuckDB.",
    "success_metrics": [
      "Endpoints implemented: /healthz, /readyz, /version, /api/v1/runs, /api/v1/runs/{run_id}, /api/v1/stats/by-model, /api/v1/stats/by-provider",
      "P95 latency < 120ms on 10k rows for list endpoints (local, warmed)",
      "All new tests green; OpenAPI available at /docs"
    ],
    "non_goals": [
      "No write endpoints or authentication in this order",
      "No streaming or server-sent events",
      "No external DB servers (stay file-based DuckDB)"
    ]
  },

  "execution": {
    "prerequisites": {
      "tools_required": ["uv"],
      "access_required": [],
      "environment_variables": ["RUNS_DB_PATH", "API_PORT", "CORS_ALLOW_ORIGINS"],
      "pre_conditions": [
        "duckdb Python package installed",
        "runs.duckdb exists locally (or service handles 'DB missing' gracefully)"
      ]
    },
    "tasks": [
      {
        "id": "T1",
        "description": "Scaffold FastAPI app with settings and read-only DuckDB connector",
        "type": "automated",
        "estimated_duration": "30m",
        "validation": "src/api/main.py starts with uvicorn; GET /healthz (service alive) and /readyz (DB reachable) and /version return expected JSON",
        "rollback": "Remove src/api/ files"
      },
      {
        "id": "T2",
        "description": "Define Pydantic models and response envelope",
        "type": "automated",
        "estimated_duration": "30m",
        "validation": "Models: RunSummary, RunDetail (config_snapshot parsed), StatsItem; Envelope: {data, meta, links}; Error: {error:{code,message,details}}",
        "rollback": "Revert model module"
      },
      {
        "id": "T3",
        "description": "Implement /api/v1/runs with filtering + cursor pagination",
        "type": "automated",
        "estimated_duration": "60m",
        "validation": "Query params: limit (default 50, max 500), cursor (base64 of 'timestamp|run_id'), date_from/date_to (ISO 8601 UTC), provider, model, status, filename_contains, sort (whitelist: timestamp, provider_name, provider_model, total_seconds, extractor_seconds; ASC/DESC). Default sort: timestamp desc, run_id desc. Returns envelope {data, meta:{returned, next_cursor, total?}, links:{self,next}} with meta.total optional.",
        "rollback": "Fallback to limit/offset implementation"
      },
      {
        "id": "T4",
        "description": "Implement /api/v1/runs/{run_id}",
        "type": "automated",
        "estimated_duration": "20m",
        "validation": "Returns a single row with config_snapshot redacted (remove api_key/token/secret/password/key/bearer fields, case-insensitive); 404 on missing run_id",
        "rollback": "Return minimal subset"
      },
      {
        "id": "T5",
        "description": "Implement /api/v1/stats/by-model and /api/v1/stats/by-provider",
        "type": "automated",
        "estimated_duration": "45m",
        "validation": "Accept date range and status filters; return counts and avg/min/max for extractor_seconds and total_seconds",
        "rollback": "Return counts-only aggregation"
      },
      {
        "id": "T6",
        "description": "Add CORS allowlist, error handlers, and OpenAPI tags",
        "type": "automated",
        "estimated_duration": "20m",
        "validation": "CORS origins from env; 400 for invalid params; 404 for not found; 500 returns structured error",
        "rollback": "Disable CORS and keep local-only"
      },
      {
        "id": "T7",
        "description": "Tests + docs + run scripts",
        "type": "automated",
        "estimated_duration": "60m",
        "validation": "tests/test_api_fastapi.py seeds temp DuckDB and covers happy/edge cases; README section shows uvicorn command and curl examples",
        "rollback": "Mark test as xfail and document limitations"
      }
    ],
    "checkpoints": [
      {
        "after_task": "T3",
        "verify": [
          "/api/v1/runs returns paginated data with filters",
          "P95 latency under target on sample data"
        ],
        "pause_for_review": false
      },
      {
        "after_task": "T5",
        "verify": [
          "Aggregations match docs/reports/duckdb-queries.sql outputs"
        ],
        "pause_for_review": false
      }
    ]
  },

  "constraints": {
    "must": [
      "Use read-only DuckDB connections for request handling",
      "Parameterize all SQL queries; whitelist sort fields",
      "Do not commit any .duckdb files",
      "Keep API stateless; config via env vars",
      "Return consistent envelope and error shapes",
      "Redact sensitive keys in config_snapshot (api_key, token, secret, password, key, bearer; case-insensitive)",
      "Treat all input timestamps as UTC; compare in UTC"
    ],
    "do_not": [
      "Do not add write endpoints",
      "Do not introduce external DB services",
      "Do not expose config_snapshot secrets"
    ],
    "performance": {
      "p95_latency_ms_list": 120,
      "max_limit": 500
    }
  },

  "error_handling": {
    "known_issues": [
      {"condition": "DB file missing", "action": "Return 503 with hint to run ingestion"},
      {"condition": "Invalid cursor/sort", "action": "Return 400 with error details"}
    ],
    "escalation_triggers": [
      "Unhandled exceptions in request handlers",
      "SQL errors detected in logs",
      "Performance targets missed by >2x"
    ],
    "fallback_strategy": "Disable filters and return a minimal runs list endpoint until fixed"
  },

  "validation": {
    "acceptance_criteria": [
      "Endpoints respond appropriately: 200 for healthy requests; 404 for missing run_id; 503 when database is missing (on /readyz and data endpoints)",
      "List endpoint supports limit, cursor, filters, and returns envelope {data, meta:{returned, next_cursor, total?}, links}",
      "Stats endpoints return counts and avg/min/max fields",
      "Errors return {error:{code,message,details}}",
      "OpenAPI served at /docs; README section added"
    ],
    "testing_instructions": [
      "uv run uvicorn src.api.main:app --reload --port ${API_PORT:-8000}",
      "curl 'http://localhost:8000/healthz'", 
      "curl 'http://localhost:8000/readyz'",
      "curl 'http://localhost:8000/api/v1/runs?limit=5'",
      "curl 'http://localhost:8000/api/v1/stats/by-model'",
      "uv run python -m pytest -q tests/test_api_fastapi.py"
    ],
    "post_execution_checks": [
      "Verify read-only connection usage in code",
      "Scan logs for SQL errors",
      "Latency spot-check on 10k-row synthetic dataset"
    ]
  },

  "metadata": {
    "created_at": "2025-10-18T00:00:00Z",
    "created_by": "agent",
    "status": "draft"
  },

  "audit": {
    "require_approval": true,
    "approvers": ["tech-lead@company.com"],
    "review_checklist": [
      "Security: no writes; parameterized SQL",
      "Performance: basic targets met",
      "Docs: endpoints + examples present"
    ]
  }
}
