{
  "order_id": "doc-parsing-fastpath-001",
  "priority": "high",
  "version": "v1.0",
  "supercontext": {
    "repository": "docling_langextract_testing",
    "mission": "Keep Docling as the primary document processor while adding a PyMuPDF fast path for digital PDFs (no OCR) and an ocrmypdf+tesseract pre-OCR step for scanned PDFs to reduce latency and cost without sacrificing quality."
  },
  "goal": "Introduce an auto-routed document parsing flow: (A) digital PDFs ‚Üí PyMuPDF fast path (no OCR), (B) scanned PDFs ‚Üí pre-OCR with ocrmypdf+tesseract then Docling with OCR disabled. Preserve existing behaviour behind toggles and surface timings and path selection in logs/exports.",
  "execution_instructions": [
    "Read this entire order before changing code.",
    "Follow CLAUDE.md mantras (start small, ship value, prefer simple patterns).",
    "Add changes behind feature flags; default behaviour must remain compatible with current pipeline.",
    "If OS dependencies (ocrmypdf/tesseract) are missing or unreliable on the target environment, pause and escalate instead of shipping partial solutions."
  ],
  "tasks": [
    {
      "id": "design-routing-heuristics",
      "description": "Define how the pipeline decides between PyMuPDF fast path and pre-OCR with ocrmypdf.",
      "steps": [
        "Decide primary heuristic: detect presence of a text layer via PyMuPDF (fitz) by checking extracted text length > threshold or PDF xref content with text operators.",
        "Define tie-breakers: if detection uncertain, prefer current Docling path or configurable default (e.g., prefer_fastpath_when_uncertain=false).",
        "Document the flow with a short docstring/diagram: upload ‚Üí detect_text_layer ‚Üí if digital ‚áí fastpath(PyMuPDF), else ‚áí pre_ocr(ocrmypdf) ‚Üí docling(do_ocr=false).",
        "Add a feature flag to enable routing: ENABLE_DOC_FASTPATH=true (default true) to allow rapid opt-out if issues arise."
      ]
    },
    {
      "id": "implement-pymupdf-fastpath",
      "description": "Add a PyMuPDF-based fast path for digital PDFs that bypasses OCR and returns text/layout needed by the extractor stage.",
      "steps": [
        "Create a new module (e.g., src/core/pymupdf_fastpath.py) that lazily imports PyMuPDF (fitz) and exposes a function `extract_text_fast(path: str) -> str`.",
        "Ensure extraction is robust to mixed-encoding PDFs; concatenate page text with separators and normalize whitespace.",
        "Return a data structure compatible with what Docling downstream expects (either plain text or a minimal adapter that the existing pipeline can consume).",
        "Add timing capture: Fastpath_Seconds per document; log 'üöÄ Fastpath(PyMuPDF) used for {file}'."
      ]
    },
    {
      "id": "implement-preocr-ocrmypdf",
      "description": "Add an ocrmypdf+tesseract pre-processing step for scanned PDFs, producing a searchable PDF for Docling to parse with OCR disabled.",
      "steps": [
        "Create a new module (e.g., src/core/pre_ocr.py) that shells out to `ocrmypdf` (subprocess) with configurable DPI/language/timeouts.",
        "Write output to a temp file (e.g., /tmp or output/tmp) and pass the resulting searchable PDF path to Docling with DOCLING_DO_OCR=false.",
        "Capture timing: PreOCR_Seconds; log 'üß† PreOCR(ocrmypdf) applied to {file}'.",
        "Handle errors: if ocrmypdf fails, fall back to current Docling path (with OCR as today) and log a clear warning."
      ]
    },
    {
      "id": "wire-config",
      "description": "Introduce feature flags and settings for the new paths.",
      "steps": [
        "Add new env toggles in src/core/config.py: ENABLE_DOC_FASTPATH (default true), ENABLE_PREOCR_OCRMYPDF (default true).",
        "Add ocrmypdf settings: OCRMYPDF_BIN (default 'ocrmypdf'), OCRMYPDF_LANG (default 'eng'), OCRMYPDF_DPI (default 300), OCRMYPDF_TIMEOUT (default 300).",
        "Expose advanced detection knobs if needed: FASTPATH_MIN_TEXT_CHARS (default 512).",
        "Update project dependencies: add pymupdf and ocrmypdf (plus optional extras) to pyproject.toml/uv.lock with pinned versions; document any OS-level requirements (ghostscript, tesseract) in pyproject optional-dependencies if appropriate.",
        "Update .env.example and docs/reference/configuration.md with the new variables and OS dependency notes (brew/apt install instructions for tesseract/ocrmypdf)."
      ]
    },
    {
      "id": "integrate-routing",
      "description": "Wrap DoclingDocumentExtractor with a small router that selects fast path vs pre-OCR path per document.",
      "steps": [
        "Implement a wrapper (e.g., src/core/document_router.py) that, given a PDF path, runs detection, chooses the path, and returns text to the existing pipeline.",
        "Ensure the router records which path was used in per-document metadata (Router_Path ‚àà {pymupdf_fastpath, preocr_docling, baseline_docling}).",
        "Respect existing toggles: if flags are disabled, route everything to baseline Docling unchanged.",
        "Keep imports lazy to avoid adding heavy dependencies at module import time.",
        "Register any new modules within package __init__ files or dependency maps if required so downstream imports resolve cleanly."
      ]
    },
    {
      "id": "timing-and-export",
      "description": "Extend timing/export to include new phases and path metadata.",
      "steps": [
        "Add PreOCR_Seconds and Fastpath_Seconds columns when timing is enabled (ENABLE_PERFORMANCE_TIMING=true).",
        "Log per-document summary: '‚è±Ô∏è {file}: Fastpath={x.xx}s, PreOCR={y.yy}s, Docling={z.zz}s, Path={...}'.",
        "Make sure CSV/JSON/XLSX exports include Router_Path and new timing fields when present."
      ]
    },
    {
      "id": "streamlit-ui",
      "description": "Add advanced settings toggles in the Streamlit UI (optional panel) for enabling/disabling fast path and pre-OCR.",
      "steps": [
        "Introduce checkboxes in an 'Advanced Settings' expander: 'Enable PyMuPDF fast path' and 'Enable pre-OCR (ocrmypdf)'.",
        "Show tooltip/help text with required OS dependencies and env vars.",
        "When toggles change, clear session results to avoid stale state (consistent with provider switching)."
      ]
    },
    {
      "id": "tests-and-validation",
      "description": "Add unit tests and manual validation to ensure no regressions.",
      "steps": [
        "Unit tests: detection heuristic (digital vs scanned) using small fixtures from tests/test_documents/ (or add minimal ones if missing).",
        "Unit tests: routing decisions honoring ENABLE_DOC_FASTPATH and ENABLE_PREOCR_OCRMYPDF toggles.",
        "If new fixtures are required (digital/scanned), add them under tests/test_documents/ and update any __init__ or conftest registration.",
        "Skip tests that require ocrmypdf if the binary isn't present; print a clear skip reason or use pytest marks (e.g., @pytest.mark.requires_ocrmypdf).",
        "Manual: run Streamlit on one digital and one scanned PDF; verify chosen path in logs and that exports include new fields."
      ]
    },
    {
      "id": "benchmark-and-docs",
      "description": "Benchmark improvements and update docs.",
      "steps": [
        "Create a small benchmark script (scripts/benchmark_fastpath_ocrmypdf.py) to compare baseline vs new routing on 1‚Äì2 sample PDFs.",
        "Record results in docs/benchmarks/ (timings per path, notes on quality parity) and include a short markdown/CSV summary committed with the change.",
        "Update README.md and docs/reference/configuration.md with a short 'Document Parsing Paths' section, toggles, and OS prerequisites."
      ]
    }
  ],
  "acceptance_criteria": [
    "Digital PDFs with a text layer use PyMuPDF fast path when ENABLE_DOC_FASTPATH=true and show 'pymupdf_fastpath' in Router_Path.",
    "Scanned PDFs run ocrmypdf pre-OCR when ENABLE_PREOCR_OCRMYPDF=true, then Docling with DOCLING_DO_OCR=false, and show 'preocr_docling' in Router_Path.",
    "Timing columns (Fastpath_Seconds and/or PreOCR_Seconds) appear when timing is enabled; logs include clear per-document summaries.",
    "Toggles off restore current baseline behaviour without breaking tests.",
    "Docs updated: .env.example + configuration reference include new variables and installation notes for ocrmypdf/tesseract.",
    "Benchmark summary artifact (docs/benchmarks/...) committed showing before/after timings and observations.",
    "Tests pass or skip gracefully when OS tools are unavailable; manual validation demonstrates improved speed on digital PDFs with no quality regressions."
  ],
  "constraints": {
    "what_not_to_do": [
      "Do not remove Docling or change default extraction semantics without flags.",
      "Do not introduce mandatory system dependencies‚Äîfast path and pre-OCR must be optional and skip cleanly when tools are missing.",
      "Do not commit large binary artifacts or vendor OS packages; document installation instead.",
      "Do not bypass existing timing/metadata patterns; extend them consistently."
    ],
    "escalation_guidance": "If ocrmypdf or tesseract installation cannot be standardized across environments, or PyMuPDF extraction deviates in ways that hurt event quality, pause and propose alternatives (e.g., stick to Docling-only with improved OCR detection). Ensure temp files created during pre-OCR are cleaned up and raise an issue if storage pressure becomes a risk."
  }
}
