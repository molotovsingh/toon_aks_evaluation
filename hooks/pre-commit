#!/bin/bash
#
# Pre-commit hook for docling_langextract_testing
#
# This hook runs fast checks on staged Python files:
# 1. Python syntax validation (py_compile)
# 2. Fast unit tests (classification prompt tests)
#
# Installation: cp hooks/pre-commit .git/hooks/ && chmod +x .git/hooks/pre-commit
# Bypass: git commit --no-verify (use sparingly!)

set -e  # Exit on first error

echo "üîç Running pre-commit checks..."

# Check if uv is available
if ! command -v uv &> /dev/null; then
    echo "‚ùå Error: 'uv' command not found. Please install uv:"
    echo "   curl -LsSf https://astral.sh/uv/install.sh | sh"
    exit 1
fi

# Get list of staged Python files
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_PY_FILES" ]; then
    echo "‚úÖ No Python files staged, skipping checks"
    exit 0
fi

echo "üìù Staged Python files:"
echo "$STAGED_PY_FILES" | sed 's/^/   /'

# Step 1: Python syntax check
echo ""
echo "1Ô∏è‚É£ Checking Python syntax..."
SYNTAX_ERRORS=0
for file in $STAGED_PY_FILES; do
    if [ -f "$file" ]; then
        if ! uv run python -m py_compile "$file" 2>&1; then
            echo "   ‚ùå Syntax error in: $file"
            SYNTAX_ERRORS=$((SYNTAX_ERRORS + 1))
        fi
    fi
done

if [ $SYNTAX_ERRORS -gt 0 ]; then
    echo ""
    echo "‚ùå Found $SYNTAX_ERRORS syntax error(s). Fix them and try again."
    exit 1
fi
echo "   ‚úÖ All staged files have valid Python syntax"

# Step 2: Run fast unit tests
echo ""
echo "2Ô∏è‚É£ Running fast unit tests..."
if ! uv run python -m unittest discover -s tests -p "test_classification_prompt.py" 2>&1; then
    echo ""
    echo "‚ùå Unit tests failed. Fix them and try again."
    echo "   Run manually: uv run python -m unittest discover -s tests -p 'test_classification_prompt.py' -v"
    exit 1
fi
echo "   ‚úÖ Fast tests passed"

echo ""
echo "‚úÖ All pre-commit checks passed!"
exit 0
